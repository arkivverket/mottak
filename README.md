# Archive Ingress Processing Application for Norways National Archives


Prototype application for recieving archives and processing them so they can later be put into storage.

The application allow someone to upload a [DIAS](https://www.arkivverket.no/forvaltning-og-utvikling/regelverk-og-standarder/dias-prosjektet-digital-arkivpakkestruktur)-encapsulated archieve into an objectstore. 

The workflow is like this:
 - Agreement is reached on transfer of an archive
 - Archive is created. The external METS XML document is sent over to an executive officer
 - The executive offiser uses the invitation UI (runs in the ) to send an invitation to upload. This is sent through email, using mailgun
 - The creator of the archive clicks the link. This invokes the [archive uploader](https://github.com/arkivverket/archive-uploader). The creator selects the created archive and uploads it.
 - The tusd container will first run the pre-upload hook an verify that there is a valid invitation for the upload.
 - Once the upload is complete the post-upload hook is run. This invokes Argo and fires off the Argo Workflow DAG.
 - The Argo Workflow will:
   - Verify the checksum of the archive
     - If the checksum doesn't match the archive is deleted and the creator is notified
   - Run antivirus on the archive
   - Pass the archive to Arkade, which will generate a HTML-based report
   - Send off an email to $SOMEBODY that there is a new archive available for further processing. Attached to the email is the log from the antivirus as well as the report generated by Arkade
  

Requirements:
 - docker containers for each component.
 - Kubernetes with Argo for workflow processing
 - Postgresql for metadata for invitations
 - Objectstore for archieves - we're using Azure Blob Storage

How to setup a new enviroment:
 - get a kubernetes cluster and make sure kubectl is operational
 - create a namespace: ```kubectl create name namespace mottak```
 - use helm to install mottak into the namespace


At this point everything should work.

You can view the Argo UI by setting up a kube proxy:

kubectl -n argo port-forward deployment/argo-ui 8001:8001

Then visit http://localhost:8001/ to view the UI.
